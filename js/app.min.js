var imagePath = "/images";
var cardPositions = {
  768: {
    profile: {
      zIndex: 1, // 1
      top: 15,
      left: 17,
    },
    "face-capture": {
      zIndex: 7, // 7
      top: 314,
      left: 242,
    },
    "last-known-location": {
      zIndex: 2, // 2
      top: 708,
      left: 27,
    },
    "known-associates": {
      zIndex: 8, // 8
      top: 13,
      left: 425,
    },
    missions: {
      zIndex: 6, // 6
      top: 77,
      left: 242,
    },
    training: {
      zIndex: 9, // 9
      top: 684,
      left: 163,
    },
    languages: {
      zIndex: 3, // 3
      top: 824,
      left: 492,
    },
    skillset: {
      zIndex: 10, // 10
      top: 446,
      left: 53,
    },
    "audio-feed": {
      zIndex: 5, // 5
      top: 1053,
      left: 343,
    },
    "server-log": {
      zIndex: 4, // 4
      top: 980,
      left: 51,
    },
  },
  980: {
    profile: {
      zIndex: 1, // 1
      top: 14,
      left: 19,
    },
    "face-capture": {
      zIndex: 6, // 6
      top: 90,
      left: 349,
    },
    "last-known-location": {
      zIndex: 2, // 2
      top: 440,
      left: 19,
    },
    "known-associates": {
      zIndex: 7, // 7
      top: 174,
      left: 235,
    },
    missions: {
      zIndex: 5, // 5
      top: 20,
      left: 452,
    },
    training: {
      zIndex: 9, // 9
      top: 444,
      left: 454,
    },
    languages: {
      zIndex: 10, // 10
      top: 606,
      left: 701,
    },
    skillset: {
      zIndex: 8, // 8
      top: 188,
      left: 704,
    },
    "audio-feed": {
      zIndex: 3, // 3
      top: 697,
      left: 52,
    },
    "server-log": {
      zIndex: 4, // 4
      top: 597,
      left: 471,
    },
  },
  1200: {
    profile: {
      zIndex: 1, // 1
      top: 14,
      left: 25,
    },
    "face-capture": {
      zIndex: 6, // 6
      top: 78,
      left: 230,
    },
    "last-known-location": {
      zIndex: 2, // 2
      top: 440,
      left: 45,
    },
    "known-associates": {
      zIndex: 7, // 7
      top: 204,
      left: 589,
    },
    missions: {
      zIndex: 4, // 4
      top: 23,
      left: 508,
    },
    training: {
      zIndex: 5, // 5
      top: 390,
      left: 690,
    },
    languages: {
      zIndex: 9, // 9
      top: 623,
      left: 573,
    },
    skillset: {
      zIndex: 10, // 10
      top: 198,
      left: 871,
    },
    "audio-feed": {
      zIndex: 3, // 3
      top: 694,
      left: 20,
    },
    "server-log": {
      zIndex: 8, // 8
      top: 559,
      left: 775,
    },
  },
  1600: {
    profile: {
      zIndex: 1, // 1
      top: 17,
      left: 54,
    },
    "face-capture": {
      zIndex: 4, // 4
      top: 32,
      left: 380,
    },
    "last-known-location": {
      zIndex: 2, // 2
      top: 446,
      left: 128,
    },
    "known-associates": {
      zIndex: 7, // 7
      top: 37,
      left: 1317,
    },
    missions: {
      zIndex: 8, // 8
      top: 79,
      left: 791,
    },
    training: {
      zIndex: 6, // 6
      top: 448,
      left: 1089,
    },
    languages: {
      zIndex: 10, // 10
      top: 609,
      left: 1137,
    },
    skillset: {
      zIndex: 9, // 9
      top: 235,
      left: 980,
    },
    "audio-feed": {
      zIndex: 3, // 3
      top: 683,
      left: 40,
    },
    "server-log": {
      zIndex: 5, // 5
      top: 568,
      left: 662,
    },
  },
};

var cards = [
  {
    title: "Profile",
    width: 280,
    html: `<div class="profile-image"><img src="${imagePath}/profile3.jpg" alt="Bryan Smith"></div>
		<div class="profile-info">
			<table>
				<tbody>
					<tr><td>Name</td><td>Bryan Smith</td></tr>
					<tr><td>Profession</td><td>Full Stack Developer</td></tr>
					<tr><td>Sex</td><td>Male</td></tr>
					<tr><td>Resume</td><td><a href="/resume/2023.pdf" download>Download Resume</a></td></tr>
				</tbody>
			</table>
		</div>`,
  },
  {
    title: "Face Capture",
    width: 500,
    html: `<div class="face-capture-image">
			<img src="${imagePath}/face-capture.jpg" alt="Bryan Smith Facial Recognition">
			<div class="face-capture-square"></div>
		</div>
		<div class="profile-info">
			<table>
				<tbody>
					<tr><td>Camera</td><td>RA717</td></tr>
					<tr><td>Match</td><td>96%</td></tr>
					<tr><td>Location</td><td>[45.51586626166933, -122.6564689497228]</td></tr>
				</tbody>
			</table>
		</div>`,
  },
  {
    title: "Last Known Location",
    width: 500,
    html: `
			<div class="us-map-wrap">
				<img class="us-map" src="${imagePath}/us-map.svg" alt="US Map">
				<div class="beacon-wrap">
					<div class="beacon-center"></div>
					<div class="beacon"></div>
				</div>
			</div>
		`,
  },
  {
    title: "Known Associates",
    width: 240,
    html: `<div class="profile-image"><img src="${imagePath}/sophie-profile.jpg" alt="Sophie Mugshot"></div>
		<div class="profile-info">
			<table>
				<tbody>
					<tr><td>Name</td><td>Sophie</td></tr>
					<tr><td>Alias</td><td>Sophiopath</td></tr>
					<tr><td>Profession</td><td>Bodyguard</td></tr>
					<tr><td>Sex</td><td>Female</td></tr>
					<tr><td>Height</td><td>2'10"</td></tr>
				</tbody>
			</table>
		</div>`,
  },
  {
    title: "Missions",
    width: 520,
    html: `
			<table>
				<tbody>
					<tr><td><a target="_blank" href="https://www.arter.fi/">Arter Oy</a></td><td>Helsinki, Finland</td><td>2013 - 2021</td><td><a href="#" onclick="modal(event)" data-title="Arter Oy">Full Report</a></td></tr>
					<tr><td><a target="_blank" href="https://oivan.com/">Oivan</a></td><td>Helsingfors, Finland</td><td>2011 - 2012</td><td><a href="#" onclick="modal(event)" data-title="Oivan">Full Report</a></td></tr>
					<tr><td>Working from home</td><td>Remote</td><td>2012 - 2013</td><td><a href="#" onclick="modal(event)" data-title="Working from home">Full Report</a></td></tr>
				</tbody>
			</table>
		`,
  },
  {
    title: "Training",
    width: 480,
    html: `<table>
			<tbody>
				<tr>
          <td>University of Helsinki</td>
          <td>2011-2015</td>
          <td>Bachelor's Degree</td>
        </tr>
			</tbody>
		</table>`,
  },
  {
    title: "Languages",
    width: 250,
    html: `<table>
			<tbody>
				<tr><td width="50%">HTML</td><td><progress value="95" max="100"></progress></td></tr>
				<tr><td>CSS</td><td><progress value="95" max="100"></progress></td></tr>
				<tr><td>Javascript</td><td><progress value="95" max="100"></progress></td></tr>
				<tr><td>NodeJS</td><td><progress value="80" max="100"></progress></td></tr>
				<tr><td>PHP</td><td><progress value="90" max="100"></progress></td></tr>
				<tr><td>SQL / NoSQL</td><td><progress value="85" max="100"></progress></td></tr>
			</tbody>
		</table>`,
  },
  {
    title: "Skillset",
    width: 250,
    html: `<table>
			<tbody>
        <tr><td>Api Creation / Integration</td></tr>
				<tr><td>Single Page Apps</td></tr>
				<tr><td>Procedural / Functional / OOP</td></tr>
				<tr><td>Search and Filtering</td></tr>
				<tr><td>Rel / Non-Rel Databases</td></tr>
				<tr><td>Google Maps / Mapbox API</td></tr>
			</tbody>
		</table>`,
  },
  {
    title: "Audio Feed",
    width: 400,
    html: `<div class="audio-feed-container"></div>`,
  },
  {
    title: "Server Log",
    width: 400,
    html: `<div class="server-log-container"></div>`,
  },
];

var highZ = cards.length + 1;
var cardsContainer = document.querySelector(".cards-container");
var cardsContainerWidth = cardsContainer.offsetWidth;

cards.forEach(function (card, i) {
  var zIndex = i === 0 ? cards.length + 1 : cards.length - i;
  var cardClass = card.title.toLowerCase().replace(/ /g, "-");
  //var allStoredStyles = (localStorage.getItem('ew-cards')) ? JSON.parse(localStorage.getItem('ew-cards')) : null;
  //var storedStyles = (allStoredStyles && allStoredStyles[cardsContainerWidth]) ? allStoredStyles[cardsContainerWidth] : null;
  var cardStyles = `width: ${card.width}px;`;

  /*if (storedStyles) {
		cardStyles += ` z-index: ${storedStyles.zIndex}; top: ${storedStyles.top}px; left: ${storedStyles.left}px`;
	}*/

  cardsContainer.innerHTML += `
		<div class="card ${cardClass}" style="${cardStyles}" tabindex="0" data-card="${cardClass}">
			<div class="card-header">
				<div class="card-title">
					<h2>${card.title}</h2>
				</div>
				<div class="card-actions">
					<a href="#" class="move-card" tabindex="-1"><i class="fa fa-arrows-alt"></i></a>
				</div>
			</div>
			<div class="card-body">
				${card.html}
			</div>
		</div>
	`;
});

// drag stuff
var dragEl = null;
var startX = 0;
var startY = 0;
var differenceX = 0;
var differenceY = 0;
var cardEls = document.querySelectorAll(".cards-container .card");

cardEls.forEach(function (card) {
  card.onfocus = function () {
    card.style.zIndex = highZ + 1;
    highZ++;
  };
});

function getTouchEvent(e) {
  var touch = e;

  if (e.type == "touchstart" || e.type == "touchmove" || e.type == "touchend" || e.type == "touchcancel") {
    var evt = typeof e.originalEvent === "undefined" ? e : e.originalEvent;
    touch = evt.touches[0] || evt.changedTouches[0];
  }

  return touch;
}

function touchstart(e) {
  var touchEvt = getTouchEvent(e);
  dragEl = null;

  if (!e.target.closest(".send-message") && !e.target.closest(".terminal")) {
    if (e.target.closest(".card")) {
      e.target.closest(".card").style.zIndex = highZ + 1;
      highZ++;
    }

    if (e.target.closest(".card-header") || e.target.closest(".modal-header")) {
      dragEl = e.target.closest(".card") ? e.target.closest(".card") : e.target.closest(".modal");
      startX = touchEvt.clientX;
      startY = touchEvt.clientY;
      differenceX = startX - dragEl.offsetLeft;
      differenceY = startY - dragEl.offsetTop;
    }
  }
}

function touchmove(e) {
  if (dragEl) {
    var touchEvt = getTouchEvent(e);
    e.preventDefault();
    dragEl.style.left = touchEvt.clientX - differenceX + "px";
    dragEl.style.top = touchEvt.clientY - differenceY + "px";
  }
}

function touchend(e) {
  if (dragEl) {
    /*var newCardPositions = (localStorage.getItem('ew-cards')) ? JSON.parse(localStorage.getItem('ew-cards')) : {};
		var containerWidth = cardsContainer.offsetWidth;
		
		cardEls.forEach(function(card) {
			if (!newCardPositions[containerWidth]) {
				newCardPositions[containerWidth] = {};
			}
			
			if (!newCardPositions[containerWidth][card.dataset.card]) {
				newCardPositions[containerWidth][card.dataset.card] = {};
			}
			
			newCardPositions[containerWidth][card.dataset.card] = {
				zIndex: card.style.zIndex, 
				top: card.offsetTop, 
				left: card.offsetLeft
			};
		});
		
		localStorage.setItem('ew-cards', JSON.stringify(newCardPositions));*/
    dragEl = null;
  }
}

document.onmousedown = touchstart;
document.ontouchstart = touchstart;
document.onmousemove = touchmove;
document.ontouchmove = touchmove;
document.onmouseup = touchend;
document.ontouchend = touchend;

// audio feed
var AudioFeed = function (options) {
  if (!options.container) {
    return;
  }
  var audioFeed = options.container;
  var audioFeedHeight = audioFeed.clientHeight;
  var barColor = options.barColor || "#fff";
  audioFeed.style.width = "100%";
  audioFeed.style.backgroundColor = options.bgColor || "#000";
  audioFeed.style.display = "table";

  var barWidth = Math.floor(audioFeed.clientWidth / 100);

  for (var i = 0; i < 100; i++) {
    audioFeed.innerHTML += '<div class="audio-bar-wrap" style="width: ' + barWidth + 'px; display: table-cell; vertical-align: bottom;"><div class="audio-bar" style="background: ' + barColor + '; margin: 0 1px; transition: .6s;"></div></div>';
  }

  setInterval(function () {
    var bars = document.querySelectorAll(".audio-bar");

    bars.forEach(function (bar) {
      var barHeight = Math.floor(Math.random() * audioFeedHeight);
      bar.style.height = barHeight + "px";
    });
  }, 100);
};

new AudioFeed({
  container: document.querySelector(".audio-feed-container"),
  barColor: "#67B6B9",
});

// server log
var serverLogContainer = document.querySelector(".server-log-container");
var serverLog = document.querySelector(".server-log .card-body");
var commands = [];

for (var i = 0; i < 20; i++) {
  var ip = Math.floor(Math.random() * 255) + "." + Math.floor(Math.random() * 255) + "." + Math.floor(Math.random() * 255) + "." + Math.floor(Math.random() * 255);
  commands.push({ text: "Decrypting " + ip + "...", typing: true });
}

new Terminal({
  container: serverLogContainer,
  typingSpeed: 50,
  loop: true,
  commands: commands,
  lineBegin: function () {
    serverLog.scrollTop = serverLog.scrollHeight;
  },
  pause: 250,
});

var terminalWrap = document.querySelector(".terminal");
var terminalContainer = document.querySelector(".terminal .card-body");

// terminal
if (window.location.pathname === "/") {
  new Terminal({
    container: document.querySelector(".terminal .card-body"),
    typingSpeed: 75,
    commands: [
      {
        text: 'load profile -firstName "Bryan" -lastName "Smith"',
        typing: true,
      },
      {
        text: "loading...",
        typing: false,
      },
    ],
    done: function () {
      setTimeout(function () {
        terminalWrap.style.display = "none";
        cardsContainer.style.visibility = "visible";

        setTimeout(function () {
          cardsContainer.classList.add("loaded");
        });
      }, 1000);
    },
  });
} else {
  new Terminal({
    container: document.querySelector(".terminal .card-body"),
    typingSpeed: 75,
    commands: [
      {
        text: "The page you were looking for does not exist",
        typing: true,
      },
      {
        text: "How did you even get here?",
        typing: true,
      },
      {
        text: '<a href="/">Go Home</a>',
        typing: false,
      },
    ],
  });
}

function positionCards() {
  if (cardsContainer.offsetWidth > 480) {
    var cardsContainerWidth = cardsContainer.offsetWidth;

    cardEls.forEach(function (card) {
      var cardObj = cardPositions[cardsContainerWidth][card.dataset.card];
      card.style.top = cardObj.top + "px";
      card.style.left = cardObj.left + "px";
      card.style.zIndex = cardObj.zIndex;
    });
  }
}

var resizeTimeout;

if (window.location.pathname === "/") {
  window.onresize = function () {
    clearTimeout(resizeTimeout);

    resizeTimeout = setTimeout(function () {
      positionCards();
    }, 500);
  };

  positionCards();
}

var missions = {
  "HCA Healthcare": `
		<h3>Role</h3>
		<p>Senior Application Engineer / Tech Lead</p>

		<h3>Directives</h3>
		<p>Design, build, and maintain the framework that manages 1000+ websites for HCA Healthcare, a Fortune 100 company. Create new apps and widgets to allow users to find physicians, services, and locations, make appointments online, and learn about facility offerings.</p>
	`,
  "Freelance Web Development": `
		<h3>Role</h3>
		<p>Full Stack Web Developer</p>

		<h3>Directives</h3>
		<p>Create custom websites remotely for various industries</p>
	`,
  "Haley Marketing": `
		<h3>Role</h3>
		<p>Front End Developer</p>

		<h3>Directives</h3>
		<p>Create custom WordPress themes for over 200 staffing agencies across the US</p>
	`,
  "Synacor, Inc.": `
		<h3>Role</h3>
		<p>Front End Developer</p>

		<h3>Directives</h3>
		<p>Create widgets for cable company customer portals</p>
	`,
};

// modal
var modalHighZ = 100;
var lastFocusEl;

function moveForward(e) {
  e.target.closest(".modal").style.zIndex = modalHighZ + 1;
  modalHighZ++;
}

function sendMessage(e) {
  e.preventDefault();
  lastFocusEl = e.target;
  modalHighZ++;
  var messageModal = document.querySelector(".send-message");
  messageModal.style.zIndex = modalHighZ;
  messageModal.style.display = "block";
  messageModal.querySelector("input").focus();
}

function closeMessageModal(e) {
  e.preventDefault();
  e.target.closest(".send-message").style.display = "none";
  lastFocusEl.focus();
}

function modal(e) {
  e.preventDefault();
  lastFocusEl = e.target;

  var title = e.target.dataset.title;
  var slug = title.toLowerCase().replace(/ /g, "-").replace(/\./g, "").replace(/,/g, "");
  var body = missions[title];

  modalHighZ++;

  if (document.querySelector(".modal." + slug)) {
    document.querySelector(".modal." + slug).style.zIndex = modalHighZ + 1;
  } else {
    var m = document.createElement("div");
    var cardsContainerWidth = cardsContainer.offsetWidth;
    var leftPos = cardsContainerWidth <= 480 ? Math.floor(Math.random() * 5) + 5 + "%" : Math.floor(Math.random() * 20) + 20 + "%";
    var topPos = Math.floor(Math.random() * 30) + 30 + "%";
    m.classList = "modal " + slug;
    m.style.left = leftPos;
    m.style.top = topPos;
    m.style.zIndex = modalHighZ;
    m.ontouchstart = moveForward;
    m.onmousedown = moveForward;
    m.tabIndex = 0;
    m.innerHTML = `
			<div class="modal-header">
				<div class="modal-title">Mission: ${title}</div>
				<div class="modal-actions"><a title="Close Modal" href="#" onclick="closeModal(event)"><i class="fa fa-times"></i></a></div>
			</div>
			<div class="modal-body">
				<span class="classified">CLASSIFIED</span>
				${body}
			</div>
		`;
    document.body.appendChild(m);
    setTimeout(function () {
      m.focus();
    });
  }
}

function closeModal(e) {
  e.preventDefault();
  e.target.closest(".modal").remove();
  lastFocusEl.focus();
}

function sendEmail(e) {
  e.preventDefault();
  var form = e.target;
  var submitBtn = form.querySelector("button");
  var data = {
    fromName: "ericwinton.com",
    fromEmail: "noreply@ericwinton.com",
    toEmail: "dev.senior.it@gmail.com",
    subject: "New message from ericwinton.com",
    message: "",
  };

  submitBtn.innerHTML = "Encrypting...";

  for (var i = 0; i < form.elements.length; i++) {
    var formEl = form.elements[i];

    if (formEl.name && formEl.value) {
      data.message += formEl.name + ": " + formEl.value + "<br />";
    }
  }

  if (data.source) {
    submitBtn.innerHTML = "Send";
    document.querySelector(".email-status").innerHTML = '<div class="message message-error">Error sending message. Please try again.</div>';
    return;
  }

  var xhr = new XMLHttpRequest();
  xhr.open("POST", "/scripts/email");
  xhr.setRequestHeader("Content-Type", "application/json");
  xhr.onload = function () {
    var res = JSON.parse(this.response);

    if (res.status === "Success") {
      submitBtn.disabled = true;
      submitBtn.innerHTML = "Message Successfully Sent";
    } else {
      submitBtn.innerHTML = "Send";
      document.querySelector(".email-status").innerHTML = '<div class="message message-error">Error sending message. Please try again.</div>';
    }
  };
  xhr.send(JSON.stringify(data));
}
